{# Copyright Christopher Adams, 2011 #}
{# All rights reserved. #}

{% extends "wyclif/base.html" %}

{% load url from future %}
{% load manuscript_extras %}

{% block extra_head %}
	<script type="text/javascript">
		$(document).ready(function(){
			$("#search-tool select").chosen();

			// todo: This needs to be made better!
			$main_search_input = $("#id_q");
			$near_prompt = $("#near-prompt-wrap")
			function check_near_prompt() {
				var text = $main_search_input.val();
				if (text.search("NEAR") > -1) {
					$near_prompt.fadeIn(500);
				} else {
					$near_prompt.fadeOut(500);
				}
			}
			check_near_prompt();			
			$main_search_input.keyup(check_near_prompt);

		});
		
	</script>
{% endblock extra_head %}

{% block navbar %}
	<h3>Search Tool</h3>
{% endblock navbar %}

{% block content %}
	{{ copy_text|safe|linebreaks }}

	<div id="search-tool">
		<h2>Search Tool (experimental)</h2>
		<form action="{% url 'wyclif.views.search' %}" method="GET">
			{{ big_search_form.non_field_errors }}
			<div class="search-field-wrapper">
		        {{ big_search_form.q.errors }}
		        <p><label for="id_q">Enter your search query below:</label></p>
				<div class="search-input-wrapper">
		        	{{ big_search_form.q }}
				</div>
				<div id="near-prompt-wrap">
					Near by how many words? {{ big_search_form.nearprompt }}
			        
				</div>
				<div class="search-instructions-wrap">
					<table class="search-instructions">
						<tbody>
							<tr><td class="search-instruction">
								*</td><td>wildcard<br>(<b>habit*</b> returns "habitus", "habito")<br>								
							</td></tr>
							<tr><td class="search-instruction">
								AND</td><td>conjunctive logical operator<br>(<b>epistola AND incipit</b> returns "epistola ... incipit")<br>
							</td></tr>
							<tr><td class="search-instruction">
								OR</td><td>disjunctive logical operator<br>(<b>ipso OR sequitur</b> returns anything with either "ipso," or "sequitur," or both)<br>
							</td></tr>
							<tr><td class="search-instruction">
								NEAR</td><td>finds words near each other in the same paragraph<br>(<b>ipso NEAR sequitur</b> returns paragraphs with "ipso" or "sequitur" near each other; you will be prompted for number of words between.)<br>
							</td></tr>
						</tbody>
					</table>
				</div>
		    </div>
			<div class="search-field-wrapper">
		        {{ big_search_form.titles.errors }}
		        <p><label for="id_titles">Limit selection to certain works:</label></p>
				<div class="search-input-wrapper">
					<a href="javascript:void(0);" onclick="
						$('select option:not(:selected)').attr('selected',true);
						$('select').chosen().trigger('liszt:updated');
					">Select All</a> |
					<a href="javascript:void(0);" onclick="
						$('select option:selected').attr('selected',false);
						$('select').chosen().trigger('liszt:updated');
					">Select None</a>
			        {{ big_search_form.titles }}
				</div>
		    </div>
		    
			
			
		<div class="submit-button-wrap"><input type="submit" value="Search" /></div>
		</form>
	</div>

	<div id="search-results">
		<div class="matched-paragraphs">
			{% if results_by_title %}
				<hr>
				<h2 id="top-of-results">Search Results ({{ num_results }} results total)</h2>
				<div>
					<ul>
					{% for title, paragraph_matches in results_by_title %}
						<li><a href="#{{ title.slug }}">{{ title.text }} ({{ paragraph_matches.count }} results)</a>
					{% endfor %}
					</ul>
				</div>
				{% for title, paragraph_matches in results_by_title %}
					<h3 id="{{ title.slug }}">{{ title.text }} ({{ paragraph_matches.count }} results)</h3>
					<ul>
					{% for paragraph in paragraph_matches %}
						<li class="matched-result wyclif-paragraph-text">
							<span class="search-result-description">{{ paragraph.chapter.heading }}, p. {{ paragraph.page.number }}: </span>
							<a href="{% url 'show-page' title=paragraph.title.slug page=paragraph.page.number %}#{{ paragraph.pk }}">{{ paragraph.text|highlight:regex_query }}</a>
							<div class="back-to-top-div"><a href="#top-of-results">Back to top</a></div>
					{% endfor %}
					</ul>
				{% endfor %}
			{% endif %}
		</div>

	</div>

{% endblock content %}